
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const { message, analysisId, userId } = await req.json()

    console.log('Medical chat request:', { message, analysisId, userId })

    // In a real implementation, this would connect to:
    // 1. OpenAI GPT-4 or similar medical AI
    // 2. Medical knowledge base
    // 3. Specialized fertility/urology training data

    const medicalResponse = await generateMedicalResponse(message, analysisId)

    return new Response(
      JSON.stringify({ response: medicalResponse }),
      { 
        headers: { 
          ...corsHeaders, 
          'Content-Type': 'application/json' 
        } 
      }
    )

  } catch (error) {
    console.error('Medical chat error:', error)
    return new Response(
      JSON.stringify({ 
        response: 'ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุชููู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุฃู ุงุณุชุดุงุฑุฉ ุทุจูุจู ุงููุฎุชุต ูุจุงุดุฑุฉ.' 
      }),
      { 
        status: 500,
        headers: { 
          ...corsHeaders, 
          'Content-Type': 'application/json' 
        } 
      }
    )
  }
})

async function generateMedicalResponse(userMessage: string, analysisId: string): Promise<string> {
  // This would be replaced with actual AI integration
  // For now, providing medically informed responses based on common queries
  
  const lowerMessage = userMessage.toLowerCase()
  
  // Medical knowledge base responses
  if (lowerMessage.includes('ุทุจูุนูุฉ') || lowerMessage.includes('ุงููุชุงุฆุฌ')) {
    return `ุจูุงุกู ุนูู ูุชุงุฆุฌ ุงูุชุญููู ุงููุนุฑูุถุฉ:

๐ **ุชูููู ุงููุชุงุฆุฌ:**
- ูุชู ุชูููู ุงููุชุงุฆุฌ ูููุงู ููุนุงููุฑ ููุธูุฉ ุงูุตุญุฉ ุงูุนุงูููุฉ (WHO 2010)
- ุงููุนุงููุฑ ุงูุทุจูุนูุฉ ุชุดูู: ุงูุชุฑููุฒ > 15 ููููู/ููุ ุงูุญุฑูุฉ ุงูุชูุฏููุฉ > 32%ุ ุงูุชุดูู ุงูุทุจูุนู > 4%

โ๏ธ **ุงูุชูุณูุฑ ุงูุทุจู:**
ุงููุชุงุฆุฌ ุชุญุชุงุฌ ูุชูุณูุฑ ุทุจู ูุชุฎุตุต ูุฃุฎุฐ ูู ุงูุงุนุชุจุงุฑ:
- ุงูุชุงุฑูุฎ ุงููุฑุถู ูุงูุนูุงูู ุงูุจูุฆูุฉ
- ุงููุญูุตุงุช ุงูููููุฉ ุงูุฃุฎุฑู
- ุงูุฃุนุฑุงุถ ุงูุณุฑูุฑูุฉ ุฅู ูุฌุฏุช

๐ **ุงูุชูุตูุฉ:**
ุฃูุตุญ ุจูุฑุงุฌุนุฉ ุทุจูุจ ูุฎุชุต ูู ุงููุณุงูู ุงูุจูููุฉ ุฃู ุทุจ ุงูุฅูุฌุงุจ ูุชูุณูุฑ ุงููุชุงุฆุฌ ุจุดูู ุฏููู ูุชุญุฏูุฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ ุฅู ูุฒู ุงูุฃูุฑ.`
  }
  
  if (lowerMessage.includes('ุญุฑูุฉ') || lowerMessage.includes('ุชูุฏููุฉ')) {
    return `๐โโ๏ธ **ุงูุญุฑูุฉ ุงูุชูุฏููุฉ (Progressive Motility):**

**ุงูุชุนุฑูู ุงูุทุจู:**
- ุงูุญุฑูุฉ ุงูุชูุฏููุฉ ุชุนูู ูุฏุฑุฉ ุงูุญููุงูุงุช ุงูููููุฉ ุนูู ุงูุญุฑูุฉ ูู ุฎุท ูุณุชููู ููุฃูุงู
- ุชุตูู ุฅูู: ุณุฑูุนุฉ ุชูุฏููุฉ (Grade A) ูุจุทูุฆุฉ ุชูุฏููุฉ (Grade B)

**ุงูุฃูููุฉ ุงูุทุจูุฉ:**
- ุถุฑูุฑูุฉ ููุตูู ุงูุญููุงู ุงููููู ููุจููุถุฉ
- ุงููุนุฏู ุงูุทุจูุนู: ุฃูุซุฑ ูู 32% ุญุฑูุฉ ุชูุฏููุฉ

**ุงูุนูุงูู ุงููุคุซุฑุฉ:**
- ุฌูุฏุฉ ุงูููุชููููุฏุฑูุง (ูุตุฏุฑ ุงูุทุงูุฉ)
- ุณูุงูุฉ ุงูุฐูู (Flagellum)
- ูุณุชูู ุงูุทุงูุฉ ุงูุฎูููุฉ

**ููููุฉ ุงูุชุญุณูู:**
- ูุธุงู ุบุฐุงุฆู ุบูู ุจูุถุงุฏุงุช ุงูุฃูุณุฏุฉ
- ููุงุฑุณุฉ ุงูุฑูุงุถุฉ ุจุงูุชุธุงู
- ุชุฌูุจ ุงูุชุฏุฎูู ูุงููุญูู
- ุฅุฏุงุฑุฉ ุงูุชูุชุฑ ูุงูุถุบุท ุงูููุณู

ูููุตุญ ุจูุฑุงุฌุนุฉ ุทุจูุจ ุงูุฐููุฑุฉ ูุชูููู ุดุงูู ููุถุน ุฎุทุฉ ุนูุงุฌูุฉ ููุงุณุจุฉ.`
  }
  
  if (lowerMessage.includes('ุชุญุณูู') || lowerMessage.includes('ุนูุงุฌ')) {
    return `๐ **ุทุฑู ุชุญุณูู ุฌูุฏุฉ ุงูุญููุงูุงุช ุงูููููุฉ:**

**1. ุงููุธุงู ุงูุบุฐุงุฆู ๐ฅ**
- ููุชุงููู C, E (ูุถุงุฏุงุช ุฃูุณุฏุฉ)
- ุงูุฒูู (ููู ูุฅูุชุงุฌ ุงูุญููุงูุงุช ุงูููููุฉ)
- ุญูุถ ุงูููููู ูููุชุงููู B12
- ุฃูููุฌุง 3 (ูู ุงูุฃุณูุงู ูุงูููุณุฑุงุช)

**2. ููุท ุงูุญูุงุฉ ๐โโ๏ธ**
- ุงูุฑูุงุถุฉ ุงูููุชุธูุฉ (ุชุฌูุจ ุงูุฅูุฑุงุท)
- ุงูููู ุงููุงูู (7-8 ุณุงุนุงุช)
- ุฅุฏุงุฑุฉ ุงูุชูุชุฑ ูุงูุถุบุท ุงูููุณู
- ุงูุญูุงุธ ุนูู ูุฒู ุตุญู

**3. ุชุฌูุจ ุงูุนูุงูู ุงูุถุงุฑุฉ โ๏ธ**
- ุงูุชุฏุฎูู ูุงููุญูู
- ุงูุญุฑุงุฑุฉ ุงูุนุงููุฉ (ุงูุญูุงูุงุช ุงูุณุงุฎูุฉ)
- ุงูููุงุฏ ุงูููููุงุฆูุฉ ูุงูุณููู
- ุงูุฅุดุนุงุน ูุงูุฃุฏููุฉ ุจุฏูู ุงุณุชุดุงุฑุฉ

**4. ุงูููููุงุช ุงูุบุฐุงุฆูุฉ ๐**
- CoQ10
- L-Carnitine  
- ูุถุงุฏุงุช ุงูุฃูุณุฏุฉ
- (ุจุนุฏ ุงุณุชุดุงุฑุฉ ุทุจูุฉ)

**โ๏ธ ุงุณุชุดุงุฑุฉ ุทุจูุฉ ูููุฉ:**
ูููุตุญ ุจูุฑุงุฌุนุฉ ุทุจูุจ ูุฎุชุต ูุชุญุฏูุฏ ุงูุณุจุจ ุงูุฌุฐุฑู ููุถุน ุฎุทุฉ ุนูุงุฌูุฉ ูุฎุตุตุฉ ูุญุงูุชู.`
  }
  
  if (lowerMessage.includes('ุทุจูุจ') || lowerMessage.includes('ูุฑุงุฌุนุฉ')) {
    return `๐ฅ **ูุชู ุชุญุชุงุฌ ููุฑุงุฌุนุฉ ุงูุทุจูุจ:**

**ุงูุญุงูุงุช ุงูุทุงุฑุฆุฉ:**
- ุชุฃุฎุฑ ุงูุญูู ุฃูุซุฑ ูู ุนุงู ูุน ูุญุงููุฉ ููุชุธูุฉ
- ูุฌูุฏ ุฃูู ุฃู ุชูุฑู ูู ุงูุฎุตูุชูู
- ุชุบููุฑุงุช ูู ุญุฌู ุฃู ุดูู ุงูุฎุตูุชูู

**ุงูุชุฎุตุตุงุช ุงูููุงุณุจุฉ:**
- **ุทุจูุจ ุงููุณุงูู ุงูุจูููุฉ:** ูููุดุงูู ุงูุชุดุฑูุญูุฉ ูุงูุงูุชูุงุจุงุช
- **ุฃุฎุตุงุฆู ุงูุบุฏุฏ ุงูุตูุงุก:** ููุดุงูู ุงููุฑูููุงุช
- **ุทุจูุจ ุงูุฅูุฌุงุจ:** ููุงุณุชุดุงุฑุฉ ุงูุดุงููุฉ

**ูุง ูุฌุจ ุฅุญุถุงุฑู ููููุนุฏ:**
- ูุชุงุฆุฌ ุงูุชุญููู ุงูุญุงููุฉ
- ุงูุชุงุฑูุฎ ุงููุฑุถู
- ูุงุฆูุฉ ุจุงูุฃุฏููุฉ ุงูุญุงููุฉ
- ุชูุงุตูู ููุท ุงูุญูุงุฉ

**ุงููุญูุตุงุช ุงููุชููุนุฉ:**
- ูุญุต ุณุฑูุฑู ุดุงูู
- ุชุญุงููู ูุฑููููุฉ
- ูุญูุตุงุช ุฅุถุงููุฉ ุญุณุจ ุงูุญุงูุฉ
- ุงุณุชุดุงุฑุฉ ุงูุชุตููุฑ ุฅู ูุฒู

**๐ก ูุตูุญุฉ ูููุฉ:**
ูุง ุชุชุฃุฎุฑ ูู ุทูุจ ุงููุณุงุนุฏุฉ ุงูุทุจูุฉ. ุงูุชุดุฎูุต ุงููุจูุฑ ูุณุงุนุฏ ูู ุงูุนูุงุฌ ุงููุนุงู.`
  }
  
  // Default response for general medical queries
  return `ุดูุฑุงู ูุณุคุงูู. ูุทุจูุจ ูุณุงุนุฏ ูุชุฎุตุตุ ุฃูุฏ ุฃู ุฃุคูุฏ ุนูู ุฃูููุฉ:

๐ **ููู ุงููุชุงุฆุฌ:**
ูู ุญุงูุฉ ูุฑุฏูุฉ ูุชุญุชุงุฌ ุชูููู ุดุฎุตู ูู ุทุจูุจ ูุฎุชุต.

๐ **ุงููุนุงููุฑ ุงูุทุจูุฉ:**
ูุชุงุฆุฌ ุงูุชุญููู ุชููุงุฑู ุจูุนุงููุฑ ููุธูุฉ ุงูุตุญุฉ ุงูุนุงูููุฉ WHO 2010.

โ๏ธ **ุงูุงุณุชุดุงุฑุฉ ุงูุทุจูุฉ:**
ุฃูุตุญ ุจุดุฏุฉ ุจูุฑุงุฌุนุฉ ุทุจูุจ ูุฎุชุต ูู ุงููุณุงูู ุงูุจูููุฉ ุฃู ุทุจ ุงูุฅูุฌุงุจ ููุญุตูู ุนูู:
- ุชูุณูุฑ ุฏููู ูููุชุงุฆุฌ
- ุฎุทุฉ ุนูุงุฌูุฉ ููุงุณุจุฉ
- ูุชุงุจุนุฉ ุทุจูุฉ ูุณุชูุฑุฉ

ูู ูุฏูู ุณุคุงู ูุญุฏุฏ ุญูู ุฌุงูุจ ูุนูู ูู ุงููุชุงุฆุฌุ`
}
